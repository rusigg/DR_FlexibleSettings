<ValueTree xmlns="http://v8.1c.ru/8.1/data/core" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:type="ValueTree">
	<column>
		<Name xsi:type="xs:string">Использовать</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Кнопка</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Источник</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Приемник</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Служебные</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Формула</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">СлужебныеТекст</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Сохранение</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">Загрузка</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">КолонкаИсточника</Name>
		<ValueType/>
	</column>
	<column>
		<Name xsi:type="xs:string">КоллекцияТЧ</Name>
		<ValueType/>
	</column>
	<row>
		<Value xsi:type="xs:boolean">true</Value>
		<Value xsi:type="xs:string">Создать заказ клиента</Value>
		<Value xsi:type="xs:string">ЭКОМ Документы</Value>
		<Value xsi:type="xs:string">Заказ_Входящий</Value>
		<Value xsi:type="xs:string">ИмяСобытия = "Создание документов по кнопке &lt;&lt;&lt; Создать заказ клиента &gt;&gt;&gt;";

РазделятьЗаказы = Настройка_Параметр_Прочитать("ЭКОМ_РазделятьЗаказы", Ложь);  
ВызовВходящимORDER = ?(ВызовВходящимORDER = Неопределено, Ложь, ВызовВходящимORDER);

// служебные переменные гибких настроек ++
ТипПриемника   = "ЗаказКлиента";
ОперацияЗапись = Ложь;
ЛогСобытий = ""; 
// служебные переменные гибких настроек --

Запрос = Новый Запрос;
Запрос.Текст = "ВЫБРАТЬ
|	ВыбранныеЗаписи.ИдентификаторЦепочки КАК ИдентификаторЦепочки,
|	ВыбранныеЗаписи.Документ КАК Документ,
|	ВыбранныеЗаписи.Идентификатор КАК Идентификатор
|ПОМЕСТИТЬ ВыбранныеЗаписи
|ИЗ
|	&amp;ТаблицаВыбранныхЗаписей КАК ВыбранныеЗаписи
|;
|
|////////////////////////////////////////////////////////////////////////////////
|ВЫБРАТЬ
|	ВыбранныеЗаписи.ИдентификаторЦепочки КАК ИдентификаторЦепочки,
|	ВыбранныеЗаписи.Документ КАК Источник,
|	ВыбранныеЗаписи.Идентификатор КАК Идентификатор,
|	МАКСИМУМ(ЕСТЬNULL(Заказ_События.Документ, ЗНАЧЕНИЕ(Документ.ЗаказКлиента.ПустаяСсылка))) КАК ДокументЗаказа1С,
|	МАКСИМУМ(ВЫБОР
|			КОГДА Заказ_События.Документ ЕСТЬ NULL
|				ТОГДА ЛОЖЬ
|			ИНАЧЕ ВЫРАЗИТЬ(Заказ_События.Документ КАК Документ.ЗаказКлиента).Проведен
|		КОНЕЦ) КАК ЗаказПроведен,
|	МАКСИМУМ(ЕСТЬNULL(Реализация_События.Документ, ЗНАЧЕНИЕ(Документ.РеализацияТоваровУслуг.ПустаяСсылка))) КАК ДокументРеализации
|ИЗ
|	ВыбранныеЗаписи КАК ВыбранныеЗаписи
|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.DR_События КАК Заказ_События
|		ПО (ВыбранныеЗаписи.ИдентификаторЦепочки = Заказ_События.ИдентификаторЦепочки)
|			И (Заказ_События.ВидДокумента = ЗНАЧЕНИЕ(Перечисление.ЭКОМ_видыдокументов.заказ_входящий))
|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.DR_События КАК Реализация_События
|		ПО (ВыбранныеЗаписи.ИдентификаторЦепочки = Реализация_События.ИдентификаторЦепочки)
|			И (Реализация_События.ВидДокумента = ЗНАЧЕНИЕ(перечисление.эком_видыдокументов.накладная_исходящая))
|
|СГРУППИРОВАТЬ ПО
|	ВыбранныеЗаписи.Документ,
|	ВыбранныеЗаписи.ИдентификаторЦепочки,
|	ВыбранныеЗаписи.Идентификатор";
Запрос.УстановитьПараметр("ТаблицаВыбранныхЗаписей", ТаблицаВыбранныхЗаписей);     
Выборка = Запрос.Выполнить().Выбрать(); 

Пока Выборка.Следующий() Цикл
                                                                                                             
	ЗапрещеноИзменениеЗаказа = Ложь;
	Если ЗначениеЗаполнено(Выборка.ДокументЗаказа1С) И Выборка.ЗаказПроведен И ЗначениеЗаполнено(Выборка.ДокументРеализации) И (Не РазделятьЗаказы ИЛИ ВызовВходящимORDER) Тогда 
			ЗапрещеноИзменениеЗаказа = Истина;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = "ВЫБРАТЬ
	               |	ЭКОМ_Документы.Ссылка КАК Ссылка
	               |ИЗ
	               |	Документ.ЭКОМ_Документы КАК ЭКОМ_Документы
	               |ГДЕ
	               |	ЭКОМ_Документы.Ссылка = &amp;Источник
	               |	И НЕ ЭКОМ_Документы.ПометкаУдаления";
	Запрос.УстановитьПараметр("Источник", Выборка.Источник);
	Результат = Запрос.Выполнить();
	ИсточникПомеченНаУдаление = Результат.Пустой(); 
	Если Не ИсточникПомеченНаУдаление И Не ЗапрещеноИзменениеЗаказа Тогда
		
		Приемник = Документы[ТипПриемника].СоздатьДокумент();

		// Получение общих для всех документов значений.
		Если КэшированныеЗначения 	= Неопределено Тогда
			КэшированныеЗначения 	= ОбработкаТабличнойЧастиКлиентСервер.ПолучитьСтруктуруКэшируемыеЗначения();
		КонецЕсли;

		ПроводитьЗаказ 				= Неопределено;
		Если НЕ КэшированныеЗначения.Свойство("ПроводитьЗаказ", ПроводитьЗаказ) Тогда
			ПроводитьЗаказ 			= Настройка_Параметр_Прочитать("ЭКОМ_СоздаватьДокументЗаказ1СПроведенным");
			КэшированныеЗначения.Вставить("ПроводитьЗаказ", ПроводитьЗаказ);
		КонецЕсли;

		ЗагружатьТекущейДатой 		= Неопределено;
		Если НЕ КэшированныеЗначения.Свойство("ЗагружатьТекущейДатой", ЗагружатьТекущейДатой) Тогда
			ЗагружатьТекущейДатой 	= Настройка_Параметр_Прочитать("ЭКОМ_ЗаказыЗагружатьТекущейДатой");
			КэшированныеЗначения.Вставить("ЗагружатьТекущейДатой", ЗагружатьТекущейДатой);
		КонецЕсли;

		КолонкиДокумента 			= Неопределено;
		Если НЕ КэшированныеЗначения.Свойство("КолонкиДокумента", КолонкиДокумента) Тогда
			КолонкиДокумента 		= Новый Соответствие;
			Для Каждого Колонка Из  Документы.ЗаказКлиента.ПустаяСсылка().Товары.ВыгрузитьКолонки().Колонки Цикл
			    КолонкиДокумента.Вставить(Колонка.Имя, Колонка.ТипЗначения.ПривестиЗначение());
			КонецЦикла;
			КэшированныеЗначения.Вставить("КолонкиДокумента", КолонкиДокумента);
		КонецЕсли;
		// Получение функциональных опций.
		ИспользоватьРасширенныеВозможностиЗаказаКлиента 	= Неопределено;
		Если НЕ КэшированныеЗначения.Свойство("ИспользоватьРасширенныеВозможностиЗаказаКлиента", ИспользоватьРасширенныеВозможностиЗаказаКлиента) Тогда
			ИспользоватьРасширенныеВозможностиЗаказаКлиента = ПолучитьФункциональнуюОпцию("ИспользоватьРасширенныеВозможностиЗаказаКлиента");
			КэшированныеЗначения.Вставить("ИспользоватьРасширенныеВозможностиЗаказаКлиента", ИспользоватьРасширенныеВозможностиЗаказаКлиента);
		КонецЕсли;

		ИспользоватьАвтоматическиеСкидкиВПродажах 			= Неопределено;
		Если НЕ КэшированныеЗначения.Свойство("ИспользоватьАвтоматическиеСкидкиВПродажах", ИспользоватьАвтоматическиеСкидкиВПродажах) Тогда
			ИспользоватьАвтоматическиеСкидкиВПродажах 		= ПолучитьФункциональнуюОпцию("ИспользоватьАвтоматическиеСкидкиВПродажах");
			КэшированныеЗначения.Вставить("ИспользоватьАвтоматическиеСкидкиВПродажах", ИспользоватьАвтоматическиеСкидкиВПродажах);
		КонецЕсли;

		ИспользоватьСоглашенияСКлиентами 					= Неопределено;
		Если НЕ КэшированныеЗначения.Свойство("ИспользоватьСоглашенияСКлиентами", ИспользоватьСоглашенияСКлиентами) Тогда
			ИспользоватьСоглашенияСКлиентами 				= ПолучитьФункциональнуюОпцию("ИспользоватьСоглашенияСКлиентами");
			КэшированныеЗначения.Вставить("ИспользоватьСоглашенияСКлиентами", ИспользоватьСоглашенияСКлиентами);
		КонецЕсли;

		ИспользоватьУправлениеДоставкой 					= Неопределено;
		Если НЕ КэшированныеЗначения.Свойство("ИспользоватьУправлениеДоставкой", ИспользоватьУправлениеДоставкой) Тогда
			ИспользоватьУправлениеДоставкой 				= ПолучитьФункциональнуюОпцию("ИспользоватьУправлениеДоставкой");
			КэшированныеЗначения.Вставить("ИспользоватьУправлениеДоставкой", ИспользоватьУправлениеДоставкой);
		КонецЕсли;

		УстановитьПривилегированныйРежим(Истина);
		// Основной запрос для заполнения шапки документа.
		Запрос = Новый Запрос;
		Запрос.Текст = 
		    "ВЫБРАТЬ
		    |    ЭКОМ_Документы.Ссылка КАК Ссылка,
		    |    ЭКОМ_Документы.Ссылка.Представление КАК ИсточникПредставление,
		    |    Приоритеты.Ссылка КАК Приоритет,
		    |    ЭКОМ_Документы.ТочкаДоставки КАК Партнер,
		    |    ЭКОМ_Документы.ТочкаДоставки.Представление КАК ПартнерПредставление,
		    |    ЭКОМ_Документы.Контрагент КАК Контрагент,
		    |    ЭКОМ_Документы.Организация КАК Организация,
		    |    ЭКОМ_Документы.ЗаказНомер КАК НомерПоДаннымКлиента,
		    |    ЭКОМ_Документы.ЗаказДата КАК ДатаПоДаннымКлиента,
		    |    ИСТИНА КАК НеОтгружатьЧастями,
		    |    ЭКОМ_Документы.ДатаПоставки КАК ЖелаемаяДатаОтгрузки,
		    |    ЭКОМ_Документы.ДатаПоставки КАК ДатаОтгрузки,
		    |    ЗНАЧЕНИЕ(Перечисление.СпособыДоставки.Самовывоз) КАК СпособДоставки,
		    |    ИСТИНА КАК СкидкиРассчитаны,
		    |    ЭКОМ_Документы.ФайлНомер КАК ФайлНомер,
		    |    ЭКОМ_Документы.ФайлДата КАК ФайлДата,
		    |    ЕСТЬNULL(ЭКОМ_GLN.Контрагент_ЦеныИз1С, ЛОЖЬ) КАК ЦеныИз1С
		    |ИЗ
		    |    Справочник.Приоритеты КАК Приоритеты,
		    |    Документ.ЭКОМ_Документы КАК ЭКОМ_Документы
		    |        ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЭКОМ_GLN КАК ЭКОМ_GLN
		    |        ПО ЭКОМ_Документы.Контрагент = ЭКОМ_GLN.Объект
		    |ГДЕ
		    |    Приоритеты.Наименование = ""Средний""
		    |    И ЭКОМ_Документы.Ссылка В(&amp;Источник)";
		Запрос.УстановитьПараметр("Источник", Выборка.Источник);
		РезультатЗапроса = Запрос.Выполнить().Выгрузить();

		// Получение данных табличной части Товары.
		Запрос = Новый Запрос;
		Запрос.Текст = 
		    "ВЫБРАТЬ
		    |	ЭКОМ_ДокументыТЧ_Товары.Ссылка КАК Ссылка,
		    |	ЭКОМ_ДокументыТЧ_Товары.Номенклатура КАК Номенклатура,
		    |	ЭКОМ_ДокументыТЧ_Товары.КоличествоПоставляемое КАК КоличествоУпаковок,
		    |	ЭКОМ_ДокументыТЧ_Товары.Цена КАК Цена,
		    |	ЭКОМ_ДокументыТЧ_Товары.ЦенаСНДС КАК ЦенаСНДС,
		    |	ВЫБОР
		    |		КОГДА ЭКОМ_ДокументыТЧ_Товары.ЕдиницаИзмерения = ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПУстаяСсылка)
		    |			ТОГДА ЭКОМ_ДокументыТЧ_Товары.ЕдиницаИзмерения
		    |		КОГДА ЭКОМ_ДокументыТЧ_Товары.ЕдиницаИзмерения.ЕдиницаИзмерения = ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПУстаяСсылка)
		    |			ТОГДА ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПУстаяСсылка)
		    |		ИНАЧЕ ЭКОМ_ДокументыТЧ_Товары.ЕдиницаИзмерения
		    |	КОНЕЦ КАК Упаковка,
		    |	ЗНАЧЕНИЕ(Справочник.ХарактеристикиНоменклатуры.ПустаяСсылка) КАК Характеристика,
		    |	ЗНАЧЕНИЕ(Справочник.Склады.ПустаяСсылка) КАК Склад,
		    |	ЛОЖЬ КАК Отменено
		    |ИЗ
		    |	Документ.ЭКОМ_Документы.ТЧ_Товары КАК ЭКОМ_ДокументыТЧ_Товары
		    |ГДЕ
		    |	ЭКОМ_ДокументыТЧ_Товары.Ссылка В(&amp;Источник)
		    |	И ЭКОМ_ДокументыТЧ_Товары.КоличествоПоставляемое &gt; 0";
		Запрос.УстановитьПараметр("Источник", Выборка.Источник);
		РезультатЗапросаТЧТовары = Запрос.Выполнить().Выгрузить();

		Если ИспользоватьУправлениеДоставкой Тогда
		    Запрос = Новый Запрос(
		        "ВЫБРАТЬ
		        |    КонтактнаяИнформация.Ссылка КАК Ссылка,
		        |    КонтактнаяИнформация.Вид.Представление КАК Вид,
		        |    КонтактнаяИнформация.Представление КАК АдресДоставки,
		        |    КонтактнаяИнформация.ЗначенияПолей КАК АдресДоставкиЗначенияПолей
		        |ИЗ
		        |    Справочник.Партнеры.КонтактнаяИнформация КАК КонтактнаяИнформация
		        |ГДЕ
		        |    КонтактнаяИнформация.Ссылка В(&amp;Партнер)
		        |    И КонтактнаяИнформация.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.Адрес)");

		    Запрос.УстановитьПараметр("Партнер", РезультатЗапроса.ВыгрузитьКолонку("Партнер"));
		    АдресаПолучателяИзКонтактнойИнформации = Запрос.Выполнить().Выгрузить();
		КонецЕсли;
		
		ТаблицаОстатки = Новый ТаблицаЗначений;
		Если РазделятьЗаказы И Не ВызовВходящимORDER Тогда
			Запрос.Текст = 
			    "ВЫБРАТЬ
			    |	ЭКОМ_ДокументыДокументыСвязанные.ДокументСвязанный КАК ДокументСвязанный,
			    |	ЭКОМ_ДокументыДокументыСвязанные.Ссылка КАК Ссылка
			    |ПОМЕСТИТЬ ДокументыСвязанные
			    |ИЗ
			    |	Документ.ЭКОМ_Документы.ДокументыСвязанные КАК ЭКОМ_ДокументыДокументыСвязанные
			    |ГДЕ
			    |	ЭКОМ_ДокументыДокументыСвязанные.Ссылка В(&amp;Источник)
			    |;
			    |
			    |////////////////////////////////////////////////////////////////////////////////
			    |ВЫБРАТЬ
			    |	ЭКОМ_ДокументыТЧ_Товары.Ссылка КАК ДокументИсточник,
			    |	ЭКОМ_ДокументыТЧ_Товары.Номенклатура КАК Номенклатура,
			    |	СУММА(ЭКОМ_ДокументыТЧ_Товары.КоличествоПоставляемое) КАК Количество
			    |ПОМЕСТИТЬ ТоварыOrder
			    |ИЗ
			    |	Документ.ЭКОМ_Документы.ТЧ_Товары КАК ЭКОМ_ДокументыТЧ_Товары
			    |ГДЕ
			    |	ЭКОМ_ДокументыТЧ_Товары.Ссылка В(&amp;Источник)
			    |	И ЭКОМ_ДокументыТЧ_Товары.КоличествоПоставляемое &gt; 0
			    |
			    |СГРУППИРОВАТЬ ПО
			    |	ЭКОМ_ДокументыТЧ_Товары.Номенклатура,
			    |	ЭКОМ_ДокументыТЧ_Товары.Ссылка
			    |;
			    |
			    |////////////////////////////////////////////////////////////////////////////////
			    |ВЫБРАТЬ
			    |	ДокументыСвязанные.Ссылка КАК ДокументИсточник,
			    |	ЗаказКлиентаТовары.Номенклатура КАК Номенклатура,
			    |	СУММА(ЗаказКлиентаТовары.Количество) КАК Количество
			    |ПОМЕСТИТЬ ТоварыЗаказы
			    |ИЗ
			    |	ДокументыСвязанные КАК ДокументыСвязанные
			    |		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ЗаказКлиента.Товары КАК ЗаказКлиентаТовары
			    |		ПО ДокументыСвязанные.ДокументСвязанный = ЗаказКлиентаТовары.Ссылка
			    |ГДЕ
			    |	ЗаказКлиентаТовары.Ссылка.ПометкаУдаления = ЛОЖЬ
			    |
			    |СГРУППИРОВАТЬ ПО
			    |	ЗаказКлиентаТовары.Номенклатура,
			    |	ДокументыСвязанные.Ссылка
			    |;
			    |
			    |////////////////////////////////////////////////////////////////////////////////
			    |ВЫБРАТЬ
			    |	ТоварыOrder.ДокументИсточник КАК ДокументИсточник,
			    |	ТоварыOrder.Номенклатура КАК Номенклатура,
			    |	ТоварыOrder.Количество - ЕСТЬNULL(ТоварыЗаказы.Количество, 0) КАК КоличествоОстаток
			    |ИЗ
			    |	ТоварыOrder КАК ТоварыOrder
			    |		ЛЕВОЕ СОЕДИНЕНИЕ ТоварыЗаказы КАК ТоварыЗаказы
			    |		ПО ТоварыOrder.Номенклатура = ТоварыЗаказы.Номенклатура
			    |			И ТоварыOrder.ДокументИсточник = ТоварыЗаказы.ДокументИсточник";
			Запрос.УстановитьПараметр("Источник", Выборка.Источник);
			ТаблицаОстатки = Запрос.Выполнить().Выгрузить();
		КонецЕсли;

		УстановитьПривилегированныйРежим(Ложь);

		Для Каждого Запись Из РезультатЗапроса Цикл
			Если (Не Разделятьзаказы ИЛИ ВызовВходящимORDER) И ЗначениеЗаполнено(Выборка.ДокументЗаказа1С) Тогда
		    	// Проверка заполненности Заказа в текущей цепочке, если заполнена - выполняется перезапись объекта
				Приемник = Выборка.ДокументЗаказа1С.ПолучитьОбъект();
				Приемник.Товары.Очистить();
				ОперацияЗапись = Истина;
			КонецЕсли;
		    
		    // Автозаполнение документа.
		    ЗаполнениеСвойствПоСтатистикеСервер.ЗаполнитьСвойстваОбъекта(Приемник, Неопределено);
		    // Заполнение реквизитов из запроса.
		    ЗаполнитьЗначенияСвойств(Приемник, Запись);
		    // Заполнение соглашения и этапов графика оплаты.
		    Если ИспользоватьСоглашенияСКлиентами Тогда
		        //Приемник.ЗаполнитьУсловияПродажПоУмолчанию();
				// Исключаем из процедуры заполнение цен.
				Если ЗначениеЗаполнено (Приемник.Партнер) Тогда
					
					УсловияПродажПоУмолчанию = ПродажиСервер.ПолучитьУсловияПродажПоУмолчанию(
						Приемник.Партнер,
						Новый Структура("УчитыватьГруппыСкладов, ВыбранноеСоглашение, ПустаяСсылкаДокумента", 
						Истина, 
						Приемник.Соглашение,
						Документы.ЗаказКлиента.ПустаяСсылка()));
					Приемник.ЗаполнитьУсловияПродаж(УсловияПродажПоУмолчанию);
					ПараметрыЗаполнения = Документы.ЗаказКлиента.ПараметрыЗаполненияНалогообложенияНДСПродажи(Приемник);
					УчетНДСУП.ЗаполнитьНалогообложениеНДСПродажи(Приемник.НалогообложениеНДС, ПараметрыЗаполнения);
					
					Если УсловияПродажПоУмолчанию &lt;&gt; Неопределено Тогда 
						УсловияПродажПоУмолчанию.Свойство("Соглашение",Приемник.Соглашение);
					Иначе
					   Приемник.Соглашение = Справочники.СоглашенияСКлиентами.ПустаяСсылка();
					КонецЕсли;	
					Если НЕ (ЗначениеЗаполнено(Приемник.Партнер) ИЛИ ЗначениеЗаполнено(Приемник.Контрагент)) Тогда
						ПартнерыИКонтрагенты.ЗаполнитьКонтрагентаПартнераПоУмолчанию(Приемник.Партнер, Приемник.Контрагент);
					КонецЕсли;
					
					Приемник.БанковскийСчетКонтрагента = ЗначениеНастроекПовтИсп.ПолучитьБанковскийСчетКонтрагентаПоУмолчанию(Приемник.Контрагент, , Приемник.БанковскийСчетКонтрагента);
					
					ПартнерыИКонтрагенты.ЗаполнитьКонтактноеЛицоПартнераПоУмолчанию(Приемник.Партнер,Приемник.КонтактноеЛицо);
					Если НЕ ИспользоватьУправлениеДоставкой Тогда
						Приемник.АдресДоставки = ФормированиеПечатныхФорм.ПолучитьАдресИзКонтактнойИнформации(Приемник.Партнер);
					КонецЕсли;
				КонецЕсли;
					
//		        Если НЕ ЗначениеЗаполнено(Приемник.Соглашение) Тогда
//		            ТекстЛогаСобытий = НСтр("ru = 'Не найдено соглашение для Партнера &lt;%Партнер%&gt;. Документ не создан'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
//		            ТекстЛогаСобытий = СтрЗаменить(ТекстЛогаСобытий, "%Партнер%", Запись.ПартнерПредставление);
//
//					ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, Перечисления.ЭКОМ_УровниЛогирования.Предупреждение, ИмяСобытия);
//					МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога); 
//		            Продолжить;
//		        КонецЕсли;

		    КонецЕсли;
		    // Заполнение адреса доставки.
		    Если ИспользоватьУправлениеДоставкой Тогда
		        АдресПолучателя = АдресаПолучателяИзКонтактнойИнформации.НайтиСтроки(Новый Структура("Ссылка, Вид", Приемник.Партнер, "Адрес доставки"));
		        ЗаполнитьЗначенияСвойств(Приемник, ?(АдресПолучателя.Количество() &gt; 0, АдресПолучателя.Получить(0), Новый Структура));
		    КонецЕсли;
		    // Установка статуса.
		    Если ИспользоватьРасширенныеВозможностиЗаказаКлиента Тогда
		        Приемник.Статус = Перечисления.СтатусыЗаказовКлиентов.КОбеспечению;
		    Иначе
		        Приемник.Статус = Перечисления.СтатусыЗаказовКлиентов.НеСогласован;
		    КонецЕсли;
			
			// Корректировка реквизитов.
			ДатаЗаказа = ТекущаяДата();
			Если НЕ ЗагружатьТекущейДатой Тогда
				ДатаЗаказа = Запись.ФайлДата;
			КонецЕсли;
			
			Приемник.Дата = ДатаЗаказа;
			Приемник.ДатаОтгрузки = ?(ЗначениеЗаполнено(Приемник.ДатаОтгрузки) И Приемник.ДатаОтгрузки &lt; НачалоДня(Приемник.Дата),
		        НачалоДня(Приемник.Дата), Приемник.ДатаОтгрузки);
		    Приемник.ЖелаемаяДатаОтгрузки = ?(ЗначениеЗаполнено(Приемник.ЖелаемаяДатаОтгрузки) И Приемник.ЖелаемаяДатаОтгрузки &lt; НачалоДня(Приемник.Дата),
		        НачалоДня(Приемник.Дата), Приемник.ЖелаемаяДатаОтгрузки);
		    Приемник.Менеджер = Пользователи.ТекущийПользователь();
		    Приемник.Комментарий = ?(ЗначениеЗаполнено(Запись.НомерПоДаннымКлиента), "Заказ № " + Запись.НомерПоДаннымКлиента, "");
		    Приемник.Комментарий = Приемник.Комментарий
		        + ?(ЗначениеЗаполнено(Приемник.Комментарий) И ЗначениеЗаполнено(Запись.ДатаПоДаннымКлиента), 
		        " от " + Формат(Запись.ДатаПоДаннымКлиента, "ДФ=dd.MM.yyyy"), "");
		    // Заполнение ответственных лиц.
		    ОтветственныеЛица = ОтветственныеЛицаСервер.ПолучитьОтветственныеЛицаОрганизации(Приемник.Организация, КонецДня(Приемник.Дата));
		    Приемник.Руководитель         = ОтветственныеЛица.РуководительСсылка;
		    Приемник.ГлавныйБухгалтер     = ОтветственныеЛица.ГлавныйБухгалтерСсылка;
		    // Заполнение Товаров.
		    Приемник.Товары.Очистить();
		    СтруктураПересчетаСуммы = ОбработкаТабличнойЧастиКлиентСервер.ПараметрыПересчетаСуммыНДСВСтрокеТЧ(Приемник);
		    ПараметрыУказанияСерий = Новый ФиксированнаяСтруктура(НоменклатураСервер.ПараметрыУказанияСерий(Приемник, Документы.ЗаказКлиента));
		    ВариантыОбеспечения = ПродажиСервер.ВариантыОбеспеченияПоУмолчанию(Приемник.Соглашение, Приемник.Статус, ПредопределенноеЗначение("Перечисление.ВариантыОбеспечения.Отгрузить"));

		СтруктураДанныеФормы = "";
		Для Каждого ТекущийРеквизит Из Метаданные.Документы.ЗаказКлиента.Реквизиты Цикл
			СтруктураДанныеФормы = СтруктураДанныеФормы + ?(ЗначениеЗаполнено(СтруктураДанныеФормы), ",", "") + ТекущийРеквизит.Имя;
		КонецЦикла;
		СтруктураПриемник = Новый Структура(СтруктураДанныеФормы);
		ЗаполнитьЗначенияСвойств(СтруктураПриемник, Приемник); 
		СтруктураПриемник.Вставить("Дата", Приемник.Дата);
		
			Если РазделятьЗаказы И Не ВызовВходящимORDER Тогда
				// актуализация количества с учетом ранее созданных заказов клиента по данному ордеру
				ОстаткиПоОрдеру = ТаблицаОстатки.НайтиСтроки(Новый Структура("ДокументИсточник", Запись.Ссылка));
				Для Каждого СтрокаОстатки Из ТаблицаОстатки Цикл
					КоличествоОстаток = СтрокаОстатки.КоличествоОстаток;
					ПараметрыОтбора = Новый Структура("Ссылка, Номенклатура", СтрокаОстатки.ДокументИсточник, СтрокаОстатки.Номенклатура);
					НайденныеСтроки = РезультатЗапросаТЧТовары.НайтиСтроки(ПараметрыОтбора);
					Для Каждого Строка Из НайденныеСтроки Цикл
							Строка.КоличествоУпаковок = Мин(КоличествоОстаток, Строка.КоличествоУпаковок);
					КонецЦикла;
				КонецЦикла;
			КонецЕсли;

		    Для Каждого Строка Из РезультатЗапросаТЧТовары.НайтиСтроки(Новый Структура("Ссылка", Запись.Ссылка)) Цикл

		        ДанныеДляЗаполнения = Новый Структура;
		        Для Каждого Колонка Из КолонкиДокумента Цикл
		            ДанныеДляЗаполнения.Вставить(Колонка.Ключ, Колонка.Значение);
		        КонецЦикла;

		        // Заполнение данных строки.
		        ЗаполнитьЗначенияСвойств(ДанныеДляЗаполнения, Строка, "Номенклатура, КоличествоУпаковок, Упаковка");
		        ДанныеДляЗаполнения.Склад = Приемник.Склад;
		        // Заполнение реквизитов строки методами конфигурации (пока без цен и сумм).
		        СтруктураДействий = Новый Структура;
		        //СтруктураДействий.Вставить("ПроверитьЗаполнитьУпаковкуПоВладельцу", ДанныеДляЗаполнения.Упаковка); // Контроль правильности заполнения единицы измерения
				Если ИспользоватьСоглашенияСКлиентами И ЗначениеЗаполнено(Приемник.Соглашение) Тогда // Цена продажи и срок поставки
				    СтруктураДействий.Вставить("ЗаполнитьУсловияПродаж", ОбработкаТабличнойЧастиКлиентСервер.ПолучитьСтруктуруЗаполненияУсловийПродажВСтрокеТЧ(Приемник));
				//Иначе
				//    СтруктураДействий.Вставить("ЗаполнитьЦенуПродажи", ОбработкаТабличнойЧастиКлиентСервер.ПолучитьСтруктуруЗаполненияЦеныВСтрокеТЧ(Приемник));
				КонецЕсли;
				//СтруктураДействий.Вставить("ЗаполнитьНоменклатуруПартнераПоНоменклатуре", Приемник.Партнер);
				СтруктураДействий.Вставить("ПересчитатьКоличествоЕдиниц");
				СтруктураДействий.Вставить("ЗаполнитьСтавкуНДС", Новый Структура("НалогообложениеНДС, Дата, ПоДатеОтгрузки", Приемник.НалогообложениеНДС, Приемник.Дата, Истина));
				СтруктураДействий.Вставить("ЗаполнитьСтавкуНДСВозвратнойТары", Приемник.ВернутьМногооборотнуюТару);
				СтруктураДействий.Вставить("ЗаполнитьСодержание", ОбработкаТабличнойЧастиКлиентСервер.ПолучитьСтруктуруЗаполненияСодержанияУслугиВСтрокеТЧ(СтруктураПриемник, Ложь));
				СтруктураДействий.Вставить("ПроверитьСериюРассчитатьСтатус", Новый Структура("Склад, ПараметрыУказанияСерий", ДанныеДляЗаполнения.Склад, ПараметрыУказанияСерий));
				ПараметрыДействия = ОбеспечениеКлиентСервер.ПараметрыДействияПроверитьЗаполнитьОбеспечение(ВариантыОбеспечения, Приемник.ЖелаемаяДатаОтгрузки);
				СтруктураДействий.Вставить("ПроверитьЗаполнитьОбеспечениеВДокументеПродажи", ПараметрыДействия);
		        ОбработкаТабличнойЧастиСервер.ОбработатьСтрокуТЧ(ДанныеДляЗаполнения, СтруктураДействий, КэшированныеЗначения);

		        // Заполнение цены.
		        Цена = 0;
		        Если Приемник.ЦенаВключаетНДС И ЗначениеЗаполнено(Строка.ЦенаСНДС) Тогда
		            Цена = Строка.ЦенаСНДС;
		        ИначеЕсли НЕ Приемник.ЦенаВключаетНДС И ЗначениеЗаполнено(Строка.Цена) Тогда
		            Цена = Строка.Цена;
		        ИначеЕсли Приемник.ЦенаВключаетНДС И ЗначениеЗаполнено(Строка.Цена) Тогда
		            Цена  = Окр((Строка.Цена * (100 + СтавкаНДСЧислом(ДанныеДляЗаполнения.СтавкаНДС))) / 100 , 4);
		        ИначеЕсли НЕ Приемник.ЦенаВключаетНДС И ЗначениеЗаполнено(Строка.ЦенаСНДС) Тогда
		            Цена = Окр((Строка.ЦенаСНДС * 100) / (100 + СтавкаНДСЧислом(ДанныеДляЗаполнения.СтавкаНДС)) , 4);
		        КонецЕсли;
		        ДанныеДляЗаполнения.Цена = Цена;
		        // Заполнение сумм методами конфигурации.
		        СтруктураДействий = Новый Структура;
		        СтруктураДействий.Вставить("ПересчитатьСуммуНДС", СтруктураПересчетаСуммы);
		        СтруктураДействий.Вставить("ПересчитатьСуммуСНДС", СтруктураПересчетаСуммы);
		        СтруктураДействий.Вставить("ПересчитатьСумму");
		        СтруктураДействий.Вставить("ПересчитатьСуммуСУчетомРучнойСкидки", Новый Структура("Очищать", Истина));
		        СтруктураДействий.Вставить("ПересчитатьСуммуСУчетомАвтоматическойСкидки", Новый Структура("Очищать", Истина));
		        ОбработкаТабличнойЧастиСервер.ОбработатьСтрокуТЧ(ДанныеДляЗаполнения, СтруктураДействий, КэшированныеЗначения);
		        // Перенос данных в строку ТЧ Товары.
		        ЗаполнитьЗначенияСвойств(Приемник.Товары.Добавить(), ДанныеДляЗаполнения);

		    КонецЦикла;

		    // Получение цен из 1С для контрагентов, у котороых стоит такая настройка.
		    Если Запись.ЦеныИз1С Тогда
		        Запрос = Новый Запрос;
		        Запрос.Текст = 
		            "ВЫБРАТЬ
		            |	Основание.НомерСтроки КАК НомерСтроки,
		            |	Основание.Номенклатура КАК Номенклатура,
		            |	Основание.Характеристика КАК Характеристика,
		            |	Основание.Упаковка КАК Упаковка,
		            |	Основание.ВидЦены КАК ВидЦены
		            |ПОМЕСТИТЬ вт
		            |ИЗ
		            |	&amp;Основание КАК Основание
		            |;
		            |
		            |////////////////////////////////////////////////////////////////////////////////
		            |ВЫБРАТЬ
		            |	вт.НомерСтроки КАК НомерСтроки,
		            |	вт.Номенклатура КАК Номенклатура,
		            |	вт.Характеристика КАК Характеристика,
		            |	вт.Упаковка КАК Упаковка,
		            |	ЦеныНоменклатурыСрезПоследних.Цена КАК Цена,
		            |	ЦеныНоменклатурыСрезПоследних.ВидЦены.ЦенаВключаетНДС КАК ЦенаВключаетНДС
		            |ПОМЕСТИТЬ втЦеныНоменклатуры
		            |ИЗ
		            |	вт КАК вт
		            |		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ЦеныНоменклатуры.СрезПоследних(&amp;ДатаЗаказа, ) КАК ЦеныНоменклатурыСрезПоследних
		            |		ПО вт.Номенклатура = ЦеныНоменклатурыСрезПоследних.Номенклатура
		            |			И вт.Характеристика = ЦеныНоменклатурыСрезПоследних.Характеристика
		            |			И вт.Упаковка = ЦеныНоменклатурыСрезПоследних.Упаковка
		            |			И вт.ВидЦены = ЦеныНоменклатурыСрезПоследних.ВидЦены
		            |;
		            |
		            |////////////////////////////////////////////////////////////////////////////////
		            |ВЫБРАТЬ
		            |	вт.Номенклатура КАК Номенклатура,
		            |	вт.Характеристика КАК Характеристика,
		            |	вт.Упаковка КАК Упаковка,
		            |	СоглашенияСКлиентамиТовары.Цена КАК Цена,
		            |	СоглашенияСКлиентамиТовары.Ссылка.ЦенаВключаетНДС КАК ЦенаВключаетНДС,
		            |	СоглашенияСКлиентамиТовары.ВидЦены КАК ВидЦены
		            |ПОМЕСТИТЬ втСоглашения
		            |ИЗ
		            |	вт КАК вт
		            |		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.СоглашенияСКлиентами.Товары КАК СоглашенияСКлиентамиТовары
		            |		ПО (вт.Номенклатура = СоглашенияСКлиентамиТовары.Номенклатура)
		            |			И (вт.Характеристика = СоглашенияСКлиентамиТовары.Характеристика)
		            |			И (вт.Упаковка = СоглашенияСКлиентамиТовары.Упаковка)
		            |ГДЕ
		            |	СоглашенияСКлиентамиТовары.Ссылка = &amp;СоглашенияСКлиентами
		            |;
		            |
		            |////////////////////////////////////////////////////////////////////////////////
		            |ВЫБРАТЬ
		            |	втЦеныНоменклатуры.НомерСтроки КАК НомерСтроки,
		            |	втЦеныНоменклатуры.Номенклатура КАК Номенклатура,
		            |	втЦеныНоменклатуры.Характеристика КАК Характеристика,
		            |	втЦеныНоменклатуры.Упаковка КАК Упаковка,
		            |	ВЫБОР
		            |		КОГДА втСоглашения.Цена = 0
		            |			ТОГДА втЦеныНоменклатуры.Цена
		            |	КОНЕЦ КАК Цена,
		            |	ЕСТЬNULL(втСоглашения.ЦенаВключаетНДС, втЦеныНоменклатуры.ЦенаВключаетНДС) КАК ЦенаВключаетНДС,
		            |	втСоглашения.ВидЦены КАК ВидЦены
		            |ИЗ
		            |	втЦеныНоменклатуры КАК втЦеныНоменклатуры
		            |		ЛЕВОЕ СОЕДИНЕНИЕ втСоглашения КАК втСоглашения
		            |		ПО (втЦеныНоменклатуры.Номенклатура = втСоглашения.Номенклатура)
		            |			И (втЦеныНоменклатуры.Характеристика = втСоглашения.Характеристика)
		            |			И (втЦеныНоменклатуры.Упаковка = втСоглашения.Упаковка)";

		        Запрос.УстановитьПараметр("Основание", Приемник.Товары);
		        Запрос.УстановитьПараметр("ДатаЗаказа", Приемник.Дата);
		        Запрос.УстановитьПараметр("СоглашенияСКлиентами", Приемник.Соглашение);

		        РезультатЗапросаЦены = Запрос.Выполнить();

		        ВыборкаДетальныеЗаписи = РезультатЗапросаЦены.Выбрать();

		        Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		            Если ЗначениеЗаполнено(ВыборкаДетальныеЗаписи.Цена)
		                И ТипЗнч(ВыборкаДетальныеЗаписи.ЦенаВключаетНДС) = Тип("Булево") Тогда
		                Строка = Приемник.Товары.Найти(ВыборкаДетальныеЗаписи.НомерСтроки, "НомерСтроки");
		                Если Строка = Неопределено Тогда
		                    Продолжить;
		                КонецЕсли;
		                Цена = 0;
		                Если Приемник.ЦенаВключаетНДС И ВыборкаДетальныеЗаписи.ЦенаВключаетНДС Тогда
		                    Цена = ВыборкаДетальныеЗаписи.Цена;
		                ИначеЕсли НЕ Приемник.ЦенаВключаетНДС И НЕ ВыборкаДетальныеЗаписи.ЦенаВключаетНДС Тогда
		                    Цена = ВыборкаДетальныеЗаписи.Цена;
		                ИначеЕсли Приемник.ЦенаВключаетНДС И НЕ ВыборкаДетальныеЗаписи.ЦенаВключаетНДС Тогда
		                    Цена  = Окр((ВыборкаДетальныеЗаписи.Цена * (100 + СтавкаНДСЧислом(Строка.СтавкаНДС))) / 100 , 4);
		                ИначеЕсли НЕ Приемник.ЦенаВключаетНДС И ВыборкаДетальныеЗаписи.ЦенаВключаетНДС Тогда
		                    Цена = Окр((ВыборкаДетальныеЗаписи.Цена * 100) / (100 + СтавкаНДСЧислом(Строка.СтавкаНДС)) , 4);
		                КонецЕсли;
		                Строка.ВидЦены = ВыборкаДетальныеЗаписи.ВидЦены;
		               
		                Если НЕ Цена = 0 Тогда
		                    Строка.Цена = Цена;
		                    // Заполнение сумм методами конфигурации.
		                    СтруктураДействий = Новый Структура;
		                    СтруктураДействий.Вставить("ПересчитатьСуммуНДС", СтруктураПересчетаСуммы);
		                    СтруктураДействий.Вставить("ПересчитатьСуммуСНДС", СтруктураПересчетаСуммы);
		                    СтруктураДействий.Вставить("ПересчитатьСумму");
		                    СтруктураДействий.Вставить("ПересчитатьСуммуСУчетомРучнойСкидки", Новый Структура("Очищать", Истина));
		                    СтруктураДействий.Вставить("ПересчитатьСуммуСУчетомАвтоматическойСкидки", Новый Структура("Очищать", Истина));
		                    ОбработкаТабличнойЧастиСервер.ОбработатьСтрокуТЧ(Строка, СтруктураДействий, КэшированныеЗначения);
		                КонецЕсли;
		            КонецЕсли;
		        КонецЦикла;
		    КонецЕсли;
		    
		    ПоследнийИндекс = Приемник.Товары.Количество() - 1;
		    Для Счетчик = 0 По ПоследнийИндекс Цикл
		      Индекс = ПоследнийИндекс - Счетчик;
		      Если Приемник.Товары[Индекс].Количество = 0 Тогда
		      	Приемник.Товары.Удалить(Индекс);
		      КонецЕсли;
		    КонецЦикла;
		    
			Если Приемник.Товары.Количество() = 0 Тогда
				ТекстЛогаСобытий = "Документ Заказ покупателя по документу " + Строка(Запись.Ссылка) +
				" не создан, т.к. не заполнены товары. Возможно по ORDER уже созданы другие заказы на все заказанное количество.";
				ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, Перечисления.ЭКОМ_УровниЛогирования.Предупреждение, ИмяСобытия);
				МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога); 
				Продолжить;
			КонецЕсли;

		    // Заполнение порядка оплаты.
		    Если Не ЗначениеЗаполнено(Приемник.ПорядокОплаты) Тогда
		        ВалютаОплаты            = ДенежныеСредстваСервер.ПолучитьВалютуОплаты(Приемник.ФормаОплаты, Приемник.БанковскийСчет, Приемник.Касса);
		        Приемник.ПорядокОплаты  = Перечисления.ПорядокОплатыПоСоглашениям.ПолучитьПорядокОплатыПоУмолчанию(Приемник.Валюта, Приемник.НалогообложениеНДС, ВалютаОплаты);
		    КонецЕсли;
		    // Заполнение этапов графика оплаты.
		    Приемник.ЗаполнитьЭтапыГрафикаОплаты();
		    // Проверка и запись документов.
		    ПроводитьЗаказ = ?(Приемник.ПроверитьЗаполнение(),ПроводитьЗаказ,Ложь);
		        НачатьТранзакцию();
		        Попытка
		            Приемник.Записать(?(ПроводитьЗаказ, РежимЗаписиДокумента.Проведение, РежимЗаписиДокумента.Запись));		            

					ВидДокументаПриемник = Перечисления.ЭКОМ_ВидыДокументов.Заказ_Входящий;															
					СтруктураРегистраDR_События = Новый Структура;
					СтруктураРегистраDR_События.Вставить("ИдентификаторЦепочки"		, Выборка.ИдентификаторЦепочки);
					СтруктураРегистраDR_События.Вставить("Документ"					, Приемник.Ссылка);
					СтруктураРегистраDR_События.Вставить("ВидДокумента"				, ВидДокументаПриемник);
					СтруктураРегистраDR_События.Вставить("Идентификатор"			, Приемник.Ссылка.УникальныйИдентификатор());
					СтруктураРегистраDR_События.Вставить("ИдентификаторОснования"	, Выборка.Идентификатор);
					СтруктураРегистраDR_События.Вставить("ДатаЗаписи"				, ТекущаяДата());
					ЭКОМ_ОбщегоНазначения.Записать_DR_События(СтруктураРегистраDR_События);				
		            
		        Исключение
					ТекстЛогаСобытий = НСтр("ru = 'Ошибка %РежимЗаписиДокумента% документа на основе входящего документа № %ФайлНомер% от %ФайлДата%. '" + ОписаниеОшибки(), ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
					ТекстЛогаСобытий = СтрЗаменить(ТекстЛогаСобытий, "%РежимЗаписиДокумента%", ?(ПроводитьЗаказ, "проведения", "записи"));
					ТекстЛогаСобытий = СтрЗаменить(ТекстЛогаСобытий, "%ФайлНомер%", Запись.ФайлНомер);
					ТекстЛогаСобытий = СтрЗаменить(ТекстЛогаСобытий, "%ФайлДата%", Формат(Запись.ФайлДата, "ДФ=dd.MM.yyyy"));
					
					ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, Перечисления.ЭКОМ_УровниЛогирования.Ошибка, ИмяСобытия);
					МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога);
					
					ОтменитьТранзакцию();
					Продолжить;
		        КонецПопытки;
		        // Запись ссылки в ЭКОМ документ.
		        Попытка
					Отбор = Новый Структура();
			        Отбор.Вставить("ДокументСвязанный", Приемник.Ссылка);
			        НайденныеСтроки = Выборка.Источник.ДокументыСвязанные.НайтиСтроки(Отбор);
					Если НайденныеСтроки.Количество() = 0 Тогда
						ИсточникОбъект = Выборка.Источник.ПолучитьОбъект();
						НовДок = ИсточникОбъект.ДокументыСвязанные.Добавить();
						НовДок.ДокументСвязанный = Приемник.Ссылка;
						ИсточникОбъект.НеВыполнятьКодПриЗаписи = Истина;
						ИсточникОбъект.Записать();
					КонецЕсли;
					ЗафиксироватьТранзакцию();
					
					Если (Не РазделятьЗаказы ИЛИ ВызовВходящимORDER) И ЗначениеЗаполнено(Выборка.ДокументЗаказа1С) Тогда
						ТекстЛогаСобытий = "Перезаписан уже существующий документ " + Строка(Выборка.ДокументЗаказа1С) + " по заказу № " + Запись.НомерПоДаннымКлиента + " от " + Запись.ДатаПоДаннымКлиента;
						ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, Перечисления.ЭКОМ_УровниЛогирования.Успешно, ИмяСобытия);
						МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога);        
				   ИначеЕсли РазделятьЗаказы И ЗначениеЗаполнено(Выборка.ДокументЗаказа1С) Тогда
						ТекстЛогаСобытий = "Разделена цепочка по заказу № " + Запись.НомерПоДаннымКлиента + " от " + Запись.ДатаПоДаннымКлиента + ". Создан документ " + Строка(Приемник.Ссылка) + ".";
						ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, Перечисления.ЭКОМ_УровниЛогирования.Успешно, ИмяСобытия);
						МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога); 
					КонецЕсли;	
				Исключение
				
					ТекстЛогаСобытий = НСтр("ru = 'Ошибка %РежимЗаписиДокумента% документа на основе входящего документа № %ФайлНомер% от %ФайлДата%. '" + ОписаниеОшибки(), ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка());
					ТекстЛогаСобытий = СтрЗаменить(ТекстЛогаСобытий, "%РежимЗаписиДокумента%", ?(ПроводитьЗаказ, "проведения", "записи"));
					ТекстЛогаСобытий = СтрЗаменить(ТекстЛогаСобытий, "%ФайлНомер%", Запись.ФайлНомер);
					ТекстЛогаСобытий = СтрЗаменить(ТекстЛогаСобытий, "%ФайлДата%", Формат(Запись.ФайлДата, "ДФ=dd.MM.yyyy"));
					
					ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, Перечисления.ЭКОМ_УровниЛогирования.Ошибка, ИмяСобытия);
					МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога);
					
					ОтменитьТранзакцию();
					Продолжить;
				
				КонецПопытки;
		  
		КонецЦикла;	
	Иначе
		Если ЗапрещеноИзменениеЗаказа Тогда
			ТекстЛогаСобытий = "По заказу " + Строка(Выборка.ДокументЗаказа1С) + " уже введена реализация " + Строка(Выборка.ДокументРеализации) + ". Изменение документа запрещено.";
			ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога(ТекстЛогаСобытий, Перечисления.ЭКОМ_УровниЛогирования.Предупреждение, ИмяСобытия);
			МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога); 
		Иначе
			ЗаписьСтруктурыЛога = ЗаполненнаяЗаписьЛога("Документ " + Выборка.Источник + " помечен на удаление, заказ клиента не создан", Перечисления.ЭКОМ_УровниЛогирования.Ошибка, ИмяСобытия);
			МассивЛогаСобытий.Добавить(ЗаписьСтруктурыЛога); 
		КонецЕсли; 
	КонецЕсли; // проверка пометки удаления источника


	// служебные операции ++  
	Если Не Приемник = Неопределено И ЗначениеЗаполнено(Приемник.Ссылка) И Не ОперацияЗапись Тогда
		КоличествоСозданныхДокументов = КоличествоСозданныхДокументов + 1;
	КонецЕсли;    
	// служебные операции --

КонецЦикла;

</Value>
		<Value xsi:type="xs:string"/>
		<Value xsi:type="xs:string"/>
		<Value xsi:type="xs:decimal">0</Value>
		<Value xsi:type="xs:decimal">0</Value>
		<Value xsi:type="xs:string">ORDER_Входящий</Value>
		<Value xsi:type="ValueListType">
			<valueType/>
			<lastId xsi:type="xs:decimal">3</lastId>
			<item>
				<value xsi:type="xs:string">ИмяКнопки</value>
				<presentation>Создать заказ клиента</presentation>
				<checkState>1</checkState>
				<id xsi:type="xs:decimal">0</id>
			</item>
			<item>
				<value xsi:type="xs:string">Покупатель</value>
				<id xsi:type="xs:decimal">1</id>
			</item>
			<item>
				<value xsi:type="xs:string">Поставщик</value>
				<checkState>1</checkState>
				<id xsi:type="xs:decimal">2</id>
			</item>
			<item>
				<value xsi:type="xs:string">ЭТРН</value>
				<id xsi:type="xs:decimal">3</id>
			</item>
		</Value>
	</row>
</ValueTree>