ТипДокументаЭКОМ_Документы	= "ДокументСсылка.ЭКОМ_Документы";
ТипДокументаЗаказа = "ДокументСсылка.ЗаказПоставщику";
ТипДокументаПоступления = "ДокументСсылка.ПриобретениеТоваровУслуг";
ТипДокументаСчетФактуры = "ДокументСсылка.СчетФактураПолученный";
ТипДокументаВозвратПоставщику = "ДокументСсылка.ВозвратТоваровПоставщику";

ИмяОрганизации = "Организация";
ИмяКонтрагента = "Контрагент";
ИмяТочкиДоставки = "Склад";
ИмяДатаПоставки = "ЖелаемаяДатаПоступления";
ДатаЗаказа1С = "ДатаПоДаннымКлиента";
НомерЗаказа1С = "НомерПоДаннымКлиента";
НомерВходящегоДокумента = "НомерВходящегоДокумента";
ДатаВходящегоДокумента = "ДатаВходящегоДокумента";
ИмяЗаказа1С = "ЗаказПоставщику";
ОснованиеВозвратаПоставщику = "ДокументПоступления";

// Блок подписки для ЭКОМ Документов, по умолчанию работает только для RETORD исходяших
// т.к. для всех остальных видов документов сведения о идентификаторе цепочки заполняются
// в шаблонах входящих \ исходящих. При необходимости кастомизации следует расширить условие
Если ТипЗнч(Источник.Ссылка) = Тип(ТипДокументаЭКОМ_Документы)
И Источник.ВидДокумента = Перечисления.ЭКОМ_ВидыДокументов.RETORD_Исходящий 
И НЕ ПустаяСтрока(Источник.ИдентификаторЦепочки) Тогда
	
	ВыборкаУчастниковВЭДО = КонтрагентУчаствуетВЭДО(Источник[ИмяОрганизации], Источник[ИмяКонтрагента]);
	Если НЕ ВыборкаУчастниковВЭДО.Количество() = 0 Тогда
		
		//Регистр DR_События
		ЗапросИдентификаторЦепочки = Новый Запрос;
		ЗапросИдентификаторЦепочки.Текст = "ВЫБРАТЬ РАЗЛИЧНЫЕ
					   |	DR_События.ИдентификаторЦепочки КАК ИдентификаторЦепочки
					   |ИЗ
					   |	РегистрСведений.DR_События КАК DR_События
					   |ГДЕ
					   |	DR_События.Документ = &Документ";
		ЗапросИдентификаторЦепочки.УстановитьПараметр("Документ", Источник.Ссылка);
		РезультатИдентификаторЦепочки = ЗапросИдентификаторЦепочки.Выполнить();
		
		ИдентификаторЦепочки   = "";
		Если РезультатИдентификаторЦепочки.Пустой() Тогда
			
			СтруктураРегистраDR_События = Новый Структура;
			СтруктураРегистраDR_События.Вставить("ИдентификаторЦепочки"		, Источник.ИдентификаторЦепочки);
			СтруктураРегистраDR_События.Вставить("Документ"					, Источник.Ссылка);
			СтруктураРегистраDR_События.Вставить("ВидДокумента"				, Источник.ВидДокумента);
			СтруктураРегистраDR_События.Вставить("Идентификатор"			, СтрЗаменить(Источник.ИмяФайла, ".xml", ""));
			СтруктураРегистраDR_События.Вставить("ДатаЗаписи"				, ТекущаяДата());
			
			ЭКОМ_ОбщегоНазначения.Записать_DR_События(СтруктураРегистраDR_События);
		КонецЕсли;	
		
		
		//Регистр DR_ЦепочкиДокументов
		ЗапросЦепочкиДокументов = Новый Запрос;
		ЗапросЦепочкиДокументов.Текст = "ВЫБРАТЬ
										|	DR_ЦепочкиДокументов.ИдентификаторЦепочки	КАК ИдентификаторЦепочки,
										|	DR_ЦепочкиДокументов.Организация			КАК Организация,
										|	DR_ЦепочкиДокументов.Контрагент				КАК Контрагент,
										|	DR_ЦепочкиДокументов.ТочкаДоставки			КАК ТочкаДоставки
										|ИЗ
										|	РегистрСведений.DR_ЦепочкиДокументов КАК DR_ЦепочкиДокументов
										|ГДЕ
										|	DR_ЦепочкиДокументов.ИдентификаторЦепочки = &ИдентификаторЦепочки";
		ЗапросЦепочкиДокументов.УстановитьПараметр("ИдентификаторЦепочки", Источник.ИдентификаторЦепочки);
		РезультатЦепочкиДокументов = ЗапросЦепочкиДокументов.Выполнить();
		ВыборкаЦепочкиДокументов = РезультатЦепочкиДокументов.Выбрать();
		ВыборкаЦепочкиДокументов.Следующий();
		
		Если РезультатИдентификаторЦепочки.Пустой() 
			ИЛИ НЕ ВыборкаЦепочкиДокументов.Организация = Источник.Организация 
			ИЛИ НЕ ВыборкаЦепочкиДокументов.Контрагент = Источник.Контрагент 
			ИЛИ НЕ ВыборкаЦепочкиДокументов.ТочкаДоставки = Источник.ТочкаДоставки Тогда	
			
			СтруктураРегистраDR_ЦепочкиДокументов = Новый Структура;
			СтруктураРегистраDR_ЦепочкиДокументов.Вставить("ДатаЗаказа"				, Источник.Дата);
			СтруктураРегистраDR_ЦепочкиДокументов.Вставить("ИдентификаторЦепочки"	, Источник.ИдентификаторЦепочки);
			СтруктураРегистраDR_ЦепочкиДокументов.Вставить("ДатаПоставки"			, Источник.ДатаПоставки);
			СтруктураРегистраDR_ЦепочкиДокументов.Вставить("НомерЗаказа"			, Источник.Номер);
			СтруктураРегистраDR_ЦепочкиДокументов.Вставить("Организация"			, Источник.Организация);
			СтруктураРегистраDR_ЦепочкиДокументов.Вставить("Контрагент"				, Источник.Контрагент);
			СтруктураРегистраDR_ЦепочкиДокументов.Вставить("ТочкаДоставки"			, Источник.ТочкаДоставки);
			СтруктураРегистраDR_ЦепочкиДокументов.Вставить("ТипОбмена"				, Перечисления.DR_ТипыОбмена.Сеть);
			
			ЭКОМ_ОбщегоНазначения.Записать_DR_ЦепочкиДокументов(СтруктураРегистраDR_ЦепочкиДокументов);
		КонецЕсли;
		
	КонецЕсли;	
КонецЕсли;
